@page
@model WypozyczalniaApp.Pages.Raporty.PrzychodyModel
@using Microsoft.AspNetCore.Html;

@{
    ViewData["Title"] = "Miesięczne Przychody";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 text-gray-800"><i class="fa-solid fa-chart-line me-2"></i>Miesięczne Przychody</h1>
    <a asp-page="./Popularnosc" class="btn btn-outline-secondary shadow-sm">
        <i class="fa-solid fa-chart-pie me-1"></i> Wykres Popularności
    </a>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3 bg-white border-bottom-0">
        <h6 class="m-0 font-weight-bold text-primary">Przychód Brutto z Opłaconych Faktur (Aktualny Rok)</h6>
    </div>
    <div class="card-body">
        <div class="chart-area" style="position: relative; height:450px;">
            <canvas id="monthlyRevenueChart"></canvas>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-white">
                <h6 class="m-0 font-weight-bold text-primary">Podsumowanie</h6>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-0">Ten wykres przedstawia trend finansowy firmy na podstawie sumy kwot brutto z faktur oznaczonych jako 'Oplacona'. Dane są agregowane po miesiącach bieżącego roku. </p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <script>
        $(document).ready(function () {
            fetch('/api/Raporty/miesieczne_przychody')
                .then(r => {
                    if (!r.ok) {
  
                        $('#monthlyRevenueChart').replaceWith('<div class="text-center p-5 text-danger">Brak uprawnień lub błąd ładowania danych.</div>');
                        return [];
                    }
                    return r.json();
                })
                .then(data => {
                    const ctx = document.getElementById('monthlyRevenueChart').getContext('2d');

                    if (data && data.length > 0) {
                        const labels = data.map(i => i.monthName);
                        const revenues = data.map(i => i.totalRevenue);

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Przychód Brutto (PLN)',
                                    data: revenues,
                                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                                    borderColor: '#4e73df',
                                    borderWidth: 3,
                                    pointRadius: 5,
                                    pointBackgroundColor: '#4e73df',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { grid: { display: false } },
                                    y: {
                                        beginAtZero: true,
                                        grid: { borderDash: [2] },
                                        ticks: {
                                            callback: function(value) {
                                                return value.toLocaleString('pl-PL', { style: 'currency', currency: 'PLN', minimumFractionDigits: 0 });
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        $('#monthlyRevenueChart').replaceWith('<div class="text-center p-5 text-muted">Brak danych opłaconych faktur w bieżącym roku.</div>');
                    }
                })
                .catch(e => console.error('Błąd ładowania wykresu:', e));
        });
    </script>
}