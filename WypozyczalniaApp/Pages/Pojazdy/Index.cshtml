@page
@model WypozyczalniaApp.Pages.Pojazdy.IndexModel
@using Microsoft.AspNetCore.Html;
@using Microsoft.AspNetCore.Mvc.Rendering;

@{
    ViewData["Title"] = "Flota Pojazdów";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 text-gray-800"><i class="fa-solid fa-car me-2"></i>Flota Pojazdów</h1>

    <div class="btn-group" role="group">
        <form method="post" asp-page-handler="ExportCsv">
            <button type="submit" class="btn btn-sm btn-success text-white shadow-sm me-2" title="Eksport danych floty do pliku CSV">
                <i class="fa-solid fa-file-csv me-1"></i> Eksport (CSV)
            </button>
        </form>

        @if (User.IsInRole("Manager") || User.IsInRole("Administrator"))
        {
            <a asp-page="Create" class="btn btn-primary shadow-sm">
                <i class="fa-solid fa-plus me-1"></i> Dodaj Pojazd
            </a>
        }
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end" id="filterForm">

            <div class="col-md-3">
                <label for="ProducerFilter" class="form-label small text-muted">Producent</label>

                <select id="ProducerFilter" name="ProducerFilter" class="form-select" asp-items="Model.AvailableProducers" onchange="filterModels()">
                    <option value="">Wszyscy Producenci</option>
                </select>
            </div>

            <div class="col-md-2">
                <label for="ModelFilter" class="form-label small text-muted">Model</label>
                <select id="ModelFilter" name="ModelFilter" class="form-select" asp-items="Model.AvailableModels">
                    <option value="">Wszystkie Modele</option>
                </select>
            </div>

            <div class="col-md-2">
                <label for="StatusFilter" class="form-label small text-muted">Status</label>
                <select id="StatusFilter" name="StatusFilter" class="form-select" asp-items="Model.AvailableStatuses">
                    <option value="">Wszystkie Statusy</option>
                </select>
            </div>

            <div class="col-md-3">
                <label for="VINFilter" class="form-label small text-muted">Szukaj VIN/Rejestracja</label>
                <input type="text" id="VINFilter" name="VINFilter" value="@Model.VINFilter" class="form-control" placeholder="VIN lub Rejestracja..." />
            </div>

            <div class="col-md-2 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary me-2"><i class="fa-solid fa-filter me-1"></i> Filtruj</button>
                <a asp-page="./Index" class="btn btn-outline-secondary"><i class="fa-solid fa-xmark me-1"></i> Reset</a>
            </div>
        </form>
    </div>
</div>

<div class="row">

    <div class="col-lg-9">


        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
                <i class="fa-solid fa-triangle-exclamation me-2"></i> @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <div class="card shadow mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                @{
                                    string GetSortArrow(string column)
                                    {
                                        if (Model.SortColumn != column) return "";
                                        return Model.SortDirection == "Asc" ? "fa-arrow-up" : "fa-arrow-down";
                                    }
                                    string GetNextSortDirection(string currentColumn)
                                    {
                                        if (Model.SortColumn != currentColumn) return "Asc";
                                        return Model.SortDirection == "Asc" ? "Desc" : "Asc";
                                    }

                                    IHtmlContent CreateSortLink(string columnName, string display, string defaultDir = "Asc")
                                    {
                                        var nextDir = GetNextSortDirection(columnName);

                                        var url = Url.Page("./Index", new
                                        {
                                            SortColumn = columnName,
                                            SortDirection = nextDir,
                                            ProducerFilter = Model.ProducerFilter,
                                            ModelFilter = Model.ModelFilter,
                                            StatusFilter = Model.StatusFilter,
                                            VINFilter = Model.VINFilter
                                        });

                                        return new HtmlString($@"
                                                                <a href='{url}' class='text-decoration-none text-dark fw-bold'>
                                                                {display} <i class='fa-solid {GetSortArrow(columnName)} ms-1'></i>
                                                                </a>");
                                    }
                                }

                                <th>@CreateSortLink("Model", "Model")</th>
                                <th>@CreateSortLink("Producent", "Producent")</th>
                                <th>@CreateSortLink("VIN", "VIN")</th>
                                <th>@CreateSortLink("DataDodania", "Data Dodania")</th>
                                <th class="text-center">@CreateSortLink("Status", "Status", "Desc")</th>
                                <th class="text-end">Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Pojazd)
                            {
                                <tr>
                                    <td class="fw-bold">@item.Model.NazwaModelu</td>
                                    <td>@Html.DisplayFor(modelItem => item.Model.Producent.Nazwa)</td>
                                    <td class="text-muted"><small>@Html.DisplayFor(modelItem => item.NumerVin)</small></td>
                                    <td class="text-muted"><small>@item.DataDodania.ToShortDateString()</small></td>
                                    <td class="text-center">
                                        @{
                                            var badgeClass = item.Status switch
                                            {
                                                "Dostepny" => "bg-success",
                                                "Wynajety" => "bg-warning text-dark",
                                                "Serwis" => "bg-danger",
                                                _ => "bg-secondary"
                                            };
                                        }
                                        <span class="badge rounded-pill @badgeClass">@item.Status</span>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group" role="group">
                                            <button type="button"
                                                    class="btn btn-sm btn-info text-white"
                                                    title="Pokaż szczegóły"
                                                    data-pojazd-id="@item.PojazdId"
                                                    onclick="loadPojazdDetails('@item.PojazdId',
                                                                                  '@(item.NumerRejestracyjny ?? "Brak")',
                                                                                  '@item.DataDodania.ToShortDateString()')">
                                                <i class="fa-solid fa-circle-info"></i>
                                            </button>

                                            @if (User.IsInRole("Manager") || User.IsInRole("Administrator"))
                                            {
                                                <a asp-page="./Edit" asp-route-id="@item.PojazdId" class="btn btn-sm btn-outline-secondary" title="Edytuj">
                                                    <i class="fa-solid fa-pen-to-square"></i>
                                                </a>
                                                <a asp-page="./Delete" asp-route-id="@item.PojazdId" class="btn btn-sm btn-outline-danger" title="Usuń">
                                                    <i class="fa-solid fa-trash-can"></i>
                                                </a>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <div class="col-lg-3">
        <div class="card shadow-sm border-info border-start-0 border-end-0 border-top-0 border-bottom-4 sticky-top" style="top: 15px;">
            <div class="card-body text-center">
                <i class="fa-solid fa-magnifying-glass fa-3x text-muted mb-3"></i>
                <h5 class="card-title">Wybierz Pojazd</h5>
                <p class="card-text small text-muted">Kliknij "Szczegóły" w tabeli, aby zobaczyć rozszerzone dane.</p>
                <div id="PojazdDetails" class="text-start mt-3">
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>

        const allModelsDataJson = '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.AllModelsData))';
        let allModelsData;

        try {

            allModelsData = JSON.parse(allModelsDataJson);
        } catch (e) {
            console.error('Błąd parsowania danych modeli. Upewnij się, że dane w modelu są czyste.', e);
            allModelsData = [];
        }

        const currentModelSelection = '@Model.ModelFilter';



        function filterModels() {
            const producerSelect = document.getElementById('ProducerFilter');
            const modelSelect = document.getElementById('ModelFilter');
            const selectedProducer = producerSelect.value;


            const defaultOption = modelSelect.options[0];

            const previousModelValue = modelSelect.value;

            modelSelect.innerHTML = '';


            if (defaultOption) {
                modelSelect.appendChild(defaultOption);
            } else {
                const newDefaultOption = document.createElement('option');
                newDefaultOption.value = '';
                newDefaultOption.textContent = 'Wszystkie Modele';
                modelSelect.appendChild(newDefaultOption);
            }


            const availableModels = new Set();

            allModelsData.forEach(item => {
                if (!selectedProducer || item.Producent.Nazwa === selectedProducer) { 
                    if (!availableModels.has(item.NazwaModelu)) { 
                        const option = document.createElement('option');
                        option.value = item.NazwaModelu;
                        option.textContent = item.NazwaModelu;

                        if (item.NazwaModelu === previousModelValue) {
                            option.selected = true;
                        }

                        modelSelect.appendChild(option);
                        availableModels.add(item.NazwaModelu);
                    }
                }
            });

            if (previousModelValue && modelSelect.value !== previousModelValue) {
                modelSelect.value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
           
            if ('@Model.ProducerFilter' && '@Model.ProducerFilter' !== '') {
                
                filterModels();
            }

        });


        function loadPojazdDetails(pojazdId, numerRejestracyjny, dataDodania) {
            const container = document.getElementById('PojazdDetails');
            container.innerHTML = '<div class="text-center text-primary"><i class="fa-solid fa-spinner fa-spin me-2"></i> Ładowanie...</div>';

            const row = $(`button[data-pojazd-id='${pojazdId}']`).closest('tr');

            const vin = row.find('td:eq(2)').text().trim();
            const model = row.find('td:eq(0)').text().trim();
            const producent = row.find('td:eq(1)').text().trim();
            const status = row.find('.badge').text().trim();


            let html = `
                <h6 class="fw-bold text-primary mb-3">ID Pojazdu: ${pojazdId}</h6>
                <p class="mb-1"><i class="fa-solid fa-tag me-2"></i><strong>Model:</strong> ${model}</p>
                <p class="mb-1"><i class="fa-solid fa-industry me-2"></i><strong>Producent:</strong> ${producent}</p>
                <p class="mb-1"><i class="fa-solid fa-barcode me-2"></i><strong>VIN:</strong> ${vin}</p>
                <p class="mb-1"><i class="fa-solid fa-circle-check me-2"></i><strong>Status:</strong> <span class="badge bg-secondary">${status}</span></p>
                <hr/>
                <h6 class="fw-bold text-dark mb-2">Dane Rozszerzone:</h6>
            `;

            fetch(`/api/PojazdyApi/details/${pojazdId}`)
                .then(response => {
                    if (!response.ok) {
                        return { ostatniSerwis: null, ostatniWynajem: null };
                    }
                    return response.json();
                })
                .then(data => {
                    const ostSerwis = data.ostatniSerwis ? new Date(data.ostatniSerwis).toLocaleDateString() : 'Brak';
                    const ostWynajem = data.ostatniWynajem ? new Date(data.ostatniWynajem).toLocaleDateString() : 'Brak';

                    const rozszerzoneHtml = `
                        <p class="mb-1"><i class="fa-solid fa-hashtag me-2 text-primary"></i> Numer Rejestracyjny: <strong>${numerRejestracyjny || 'Brak'}</strong></p>
                        <p class="mb-1"><i class="fa-solid fa-calendar-plus me-2 text-muted"></i> Data Dodania: <strong>${dataDodania}</strong></p>

                        <p class="mb-1"><i class="fa-solid fa-wrench me-2 text-muted"></i> Ost. Serwis: <strong>${ostSerwis}</strong></p>
                        <p class="mb-1"><i class="fa-solid fa-hourglass-start me-2 text-muted"></i> Ost. Wynajem: <strong>${ostWynajem}</strong></p>
                    `;
                    container.innerHTML = html + rozszerzoneHtml;
                })
                .catch(error => {
                    container.innerHTML = html + `<p class="text-danger small">Błąd ładowania historii. Sprawdź, czy API działa.</p>`;
                    console.error('Error loading details:', error);
                });
        }
    </script>
}