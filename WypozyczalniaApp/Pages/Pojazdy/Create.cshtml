@page
@model WypozyczalniaApp.Pages.Pojazdy.CreateModel

@{
    ViewData["Title"] = "Dodaj Pojazd";
}

<h1>Dodaj Nowy Pojazd</h1>
<hr />
<div class="row">
    <div class="col-md-5">
        <form method="post">
            <div asp-validation-summary="All" class="text-danger mb-3 border p-3 bg-light"></div>


            <div class="form-group mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <label class="control-label">Producent</label>
                    <a asp-page="/Producenci/Create" target="_blank" class="small text-decoration-none">
                        <i class="fa-solid fa-plus-circle me-1"></i> Dodaj
                    </a>
                </div>
                <select id="ProducerSelect" class="form-select" asp-items="Model.AvailableProducenci" onchange="filterModels()">
                    <option value="">-- Wybierz Producenta --</option>
                </select>
            </div>

            <div class="form-group mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <label asp-for="Pojazd.ModelId" class="control-label">Model Pojazdu</label>
                    <a asp-page="/Modele/Create" target="_blank" class="small text-decoration-none">
                        <i class="fa-solid fa-plus-circle me-1"></i> Dodaj
                    </a>
                </div>

                <select asp-for="Pojazd.ModelId" id="ModelSelect" class="form-select">
                    <option value="">-- Wybierz Model --</option>
                </select>
                <span asp-validation-for="Pojazd.ModelId" class="text-danger"></span>
            </div>



            <div class="form-group mb-3">
                <label asp-for="Pojazd.NumerVin" class="control-label">Numer VIN</label>
                <input asp-for="Pojazd.NumerVin" class="form-control" />
                <span asp-validation-for="Pojazd.NumerVin" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Pojazd.NumerRejestracyjny" class="control-label">Numer Rejestracyjny</label>
                <input asp-for="Pojazd.NumerRejestracyjny" class="form-control" />
                <span asp-validation-for="Pojazd.NumerRejestracyjny" class="text-danger"></span>
            </div>


            <div class="form-group mb-3">
                <label asp-for="Pojazd.DataDodania" class="control-label">Data Dodania</label>
                <input asp-for="Pojazd.DataDodania" class="form-control" type="date" />
                <span asp-validation-for="Pojazd.DataDodania" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Pojazd.Status" class="control-label">Status Początkowy</label>
                <select asp-for="Pojazd.Status" class="form-control">
                    <option value="Dostepny">Dostepny</option>
                    <option value="Serwis">Serwis</option>
                    <option value="Wynajety">Wynajety</option>
                </select>
                <span asp-validation-for="Pojazd.Status" class="text-danger"></span>
            </div>

            <div class="form-group">
                <input type="submit" value="Utwórz" class="btn btn-primary" />
                <a asp-page="Index" class="btn btn-secondary">Anuluj</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
  
        const allModelsDataJson = '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.AllModelsData))';
        let allModelsData;

        try {
            allModelsData = JSON.parse(allModelsDataJson);
        } catch (e) {
            console.error('Błąd parsowania danych modeli.', e);
            allModelsData = [];
        }

        function filterModels() {
            const producerSelect = document.getElementById('ProducerSelect');
            const modelSelect = document.getElementById('ModelSelect');
            const selectedProducerId = producerSelect.value;

  
            modelSelect.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Wybierz Model --';
            modelSelect.appendChild(defaultOption);

            if (selectedProducerId) {
 
                const filteredModels = allModelsData.filter(item =>
                    item.ProducentId.toString() === selectedProducerId
                );

                filteredModels.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.ModelId;
                    option.textContent = item.NazwaModelu;
                    modelSelect.appendChild(option);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const producerSelect = document.getElementById('ProducerSelect');

            if ('@Model.Pojazd.ModelId' && '@Model.Pojazd.ModelId' !== '0') {

                 if (producerSelect.value) {
                     filterModels();
                     document.getElementById('ModelSelect').value = '@Model.Pojazd.ModelId';
                 }
            }
        });
    </script>
}